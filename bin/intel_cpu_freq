#!/usr/bin/env bash

# Configures maximum frequency in GHz if the CPU is Intel and supports it.

usage="Usage: $0 {get|set FREQ}"

case "$1" in
  get)
    [[ $# -ne 1 ]] && echo "$usage" && exit 1
    cpupower frequency-info
    ;;
  set)
    [[ $# -ne 2 ]] && echo "$usage" && exit 1
    [[ "$2" != [0-9]\.[0-9] ]] \
      && echo "Frequency must be a decimal between 0.0 and 9.9 GHz!" \
      && exit 1
    cat <<EOF | sudo tee /etc/systemd/system/cpupower.service
[Unit]
Description=CPU governor and frequency config.
[Service]
Type=oneshot
ExecStart=/usr/bin/cpupower -c all frequency-set -g powersave -u "${2}GHz"
[Install]
WantedBy=multi-user.target
EOF
    sudo systemctl daemon-reload
    sudo systemctl enable cpupower.service
    sudo systemctl restart cpupower.service
    ;;
  *) echo "$usage" && exit 1 ;;
esac
